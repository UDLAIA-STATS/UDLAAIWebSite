---
import "@styles/global.css";
import Layout from "@layouts/Layout.astro";
import arrowNext from "@assets/arrow_next.svg";

export const prerender = false;

const inputClass =
  "bg-white text-black rounded-md p-2 w-md focus:outline-none focus:ring-2 focus:ring-[#C10230]";

const loggedInUser = Astro.cookies.get("user")
  ? (JSON.parse(Astro.cookies.get("user")?.value as string) as LoggedUser)
  : null;
;
---

<Layout>
  <section
    class="md:w-svw lg:w-max h-svh text-white flex flex-wrap justify-self-center-safe flex-col mt-16"
  >
    <div
      id="container"
      class="flex flex-col items-center justify-center gap-5 rounded-sm bg-[#C10230] self-center w-shw px-5 pt-4 pb-8"
    >
      <div class="font-bold text-3xl flex pb-3">
        <h1>Inicio de Sesión</h1>
      </div>
      <div id="register-form" class="flex flex-col gap-5">
        <form autocomplete="on" method="post">
          <div class="flex flex-col gap-2 mb-4 px-5">
            <label class="text-base font-medium" for="name">Usuario</label>
            <input
              type="text"
              maxlength="70"
              id="name"
              name="name"
              class={inputClass}
              required
            />
          </div>
          <div class="flex flex-col gap-2 mb-4 px-5">
            <label class="text-base font-medium" for="password"
              >Contraseña</label
            >
            <input
              type="password"
              maxlength="30"
              id="password"
              name="password"
              class={inputClass}
              required
            />
          </div>
          <div class="flex flex-row gap-2 mb-4 px-5 justify-between" hidden>
            <div>
              <input
                type="checkbox"
                id="rememberMe"
                name="rememberMe"
                class="mr-1 align-middle size-fit"
              />
              <label for="rememberMe" class="text-sm">Recuérdame</label>
            </div>
          </div>
          <div class="flex justify-center mt-5 pt-2">
            <button
              class="disabled:bg-gray-300 text-[#C10230] bg-white border-[#C10230] border-solid border-2 px-4 py-2 rounded-md cursor-pointer flex gap-2"
              type="submit"
              id="btn-login"
              >Iniciar Sesión
              <img
                src={arrowNext.src}
                class="size-7 align-middle pl-2 rotate-180"
                alt=""
              />
            </button>
          </div>
        </form>
      </div>
    </div>
  </section>
</Layout>

<script>
  import { actions } from "astro:actions";
  import Swal from "sweetalert2";

  const form = document.querySelector("form");
  const btnSubmit = form!.querySelector(
    "button[type='submit']"
  ) as HTMLButtonElement;

  form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      btnSubmit.setAttribute("disabled", "disabled");

      const formData = new FormData(form);

      const { data, error } = await actions.login(formData);

      if (error) {
        Swal.fire({
          icon: "error",
          title: "Error al iniciar sesión",
          text: error.message,
        });
        btnSubmit.removeAttribute("disabled");
        return;
      }

      btnSubmit.removeAttribute("disabled");
      window.location.replace("/");
    });
</script>
