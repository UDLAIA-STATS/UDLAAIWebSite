---
import "@styles/global.css";
import FormLayout from "@layouts/FormLayout.astro";
import {
  Input,
  ComboBox,
  FormButtons,
  TextArea,
} from "@components/forms/index";

const user = Astro.cookies.get("user")
  ? (JSON.parse(Astro.cookies.get("user")?.value as string) as LoggedUser)
  : null;
---

<FormLayout
  formTitle={"Agregar Temporada"}
  pageTitle={"Agregar Temporada"}
  user={user}
>
  <form id="form-temporada" class="flex flex-col w-full max-w-md">
    <!-- Nombre de temporada -->
    <Input id="nombretemporada" label="Nombre de la Temporada" type="text" />

    <!-- Temporada activa -->
    <ComboBox id="temporadaactiva" label="Temporada Activa">
      <option value="true" selected>S铆</option>
      <option value="false">No</option>
    </ComboBox>

    <!-- Tipo de temporada -->
    <ComboBox id="tipotemporada" label="Tipo de Temporada">
      <option value="" disabled selected>Selecciona un tipo</option>
      <option value="Oficial">Oficial</option>
    </ComboBox>

    <!-- Fecha de inicio -->
    <Input id="fechainiciotemporada" label="Fecha de Inicio" type="date" />

    <!-- Fecha de fin -->
    <Input id="fechafintemporada" label="Fecha de Fin" type="date" />

    <!-- Descripci贸n de temporada -->
    <TextArea
      id="descripciontemporada"
      label="Descripci贸n"
      maxlength={250}
      rows={3}
    />

    <!-- Botones -->
    <FormButtons label="Agregar Temporada" />
  </form>
</FormLayout>

<script>
  import Swal from "sweetalert2";
  import { actions } from "astro:actions";
  import { navigate } from "astro:transitions/client";
  import { privateRoutesMap } from "@consts/routes";
  import { validateTemporadas } from "@utils/validation/partidos/temporadas-validation";

  const btnSubmit = document.getElementById("btn-submit") as HTMLButtonElement;
  const btnCancel = document.getElementById("btn-cancel") as HTMLButtonElement;
  const form = document.getElementById("form-temporada") as HTMLFormElement;

  btnCancel.addEventListener("click", () => {
    navigate(privateRoutesMap.VER_TEMPORADAS);
  });

  btnSubmit.addEventListener("click", async () => {
    btnSubmit.disabled = true;
    btnSubmit.classList.add("opacity-50", "cursor-not-allowed");

    const formData = new FormData(form);
    const errorMessage = validateTemporadas(formData);

    if (errorMessage) {
      Swal.fire("Error", errorMessage, "error").then(() => {
        btnSubmit.disabled = false;
        btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
      });
      return;
    }

    //  Normalizaci贸n de datos antes de enviar
    const tipo = formData.get("tipotemporada")?.toString() ?? "";
    const fechaInicio = formData.get("fechainiciotemporada")?.toString();
    const fechaFin = formData.get("fechafintemporada")?.toString();

    // Convertimos fechas a formato ISO si existen
    const fechaInicioISO = fechaInicio
      ? new Date(fechaInicio).toISOString()
      : "";
    const fechaFinISO = fechaFin ? new Date(fechaFin).toISOString() : "";

    // Creamos un nuevo FormData limpio con los tipos correctos
    formData.set(
      "nombretemporada",
      formData.get("nombretemporada")?.toString().trim() ?? ""
    );
    formData.set(
      "descripciontemporada",
      formData.get("descripciontemporada")?.toString().trim() ?? ""
    );
    formData.set("tipotemporada", tipo);
    formData.set("fechainiciotemporada", fechaInicioISO);
    formData.set("fechafintemporada", fechaFinISO);
    formData.set(
      "temporadaactiva",
      formData.get("temporadaactiva")?.toString() ?? ""
    );

    try {
      const { data, error } = await actions.createTemporada(formData);

      if (error) {
        Swal.fire("Error", error.message, "error");
        btnSubmit.disabled = false;
        btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
        return;
      }

      Swal.fire("xito", "Temporada creada exitosamente", "success").then(
        () => {
          navigate(privateRoutesMap.VER_TEMPORADAS);
        }
      );

      form.reset();
    } catch (err) {
      console.error("Error al crear temporada:", err);
      Swal.fire("Error", "Ocurri贸 un problema al crear la temporada", "error");
      btnSubmit.disabled = false;
      btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
    } finally {
      btnSubmit.disabled = false;
      btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
    }
  });
</script>
