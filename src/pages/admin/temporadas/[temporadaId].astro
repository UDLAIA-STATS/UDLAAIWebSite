---
import "@styles/global.css";
import FormLayout from "@layouts/FormLayout.astro";
import arrowNext from "@assets/arrow_next.svg";
import Swal from "sweetalert2";
import { actions } from "astro:actions";
import { privateRoutesMap, buttonClass, inputClass } from "@consts/index";

const { temporadaId } = Astro.params;

const user = Astro.cookies.get("user")
  ? (JSON.parse(Astro.cookies.get("user")?.value as string) as LoggedUser)
  : null;

const { data: temporadaData, error: errorTemporada } = await Astro.callAction(
  actions.getTemporadaById,
  { id: Number.parseInt(temporadaId ?? "0") }
);

if (errorTemporada || !temporadaData) {
  console.error("Error fetching temporada:", errorTemporada);
  Swal.fire("Error", "Error al cargar la temporada", "error").then(() => {
    Astro.redirect(privateRoutesMap.VER_TEMPORADAS);
  });
}

const temporada = temporadaData!.data;
---

<FormLayout
  formTitle={"Editar Temporada"}
  pageTitle={"Editar Temporada"}
  user={user}
>
  <form id="form-temporada" class="flex flex-col w-full max-w-md">
    <input
      type="hidden"
      name="idtemporada"
      value={temporada?.idtemporada ?? ""}
    />

    <!-- Nombre -->
    <div class="flex flex-col gap-2 mb-4">
      <label for="nombretemporada" class="text-base font-medium">Nombre de la Temporada</label>
      <input
        id="nombretemporada"
        name="nombretemporada"
        type="text"
        maxlength="100"
        value={temporada?.nombretemporada ?? ""}
        class={inputClass}
      />
    </div>

        <!-- Temporada activa -->
    <div class="flex gap-2 flex-col mb-4">
      <label for="temporadaactiva" class="text-base font-medium">
        Temporada Activa
      </label>
      <select name="temporadaactiva" class={inputClass} id="temporadaactiva">
        <option value="true" selected={temporada?.temporadaactiva}>S铆</option>
        <option value="false" selected={!temporada?.temporadaactiva}>No</option>
      </select>
    </div>

    <!-- Tipo -->
    <div class="flex flex-col gap-2 mb-4">
      <label for="tipotemporada" class="text-base font-medium">Tipo de Temporada</label>
      <select name="tipotemporada" id="tipotemporada" class={inputClass}>
        <option value="" disabled>Selecciona un tipo</option>
        <option value="Oficial" selected={temporada?.tipotemporada === "Oficial"}>Oficial</option>
        <option value="Amistosa" selected={temporada?.tipotemporada === "Amistosa"}>Amistosa</option>
      </select>
    </div>

    <!-- Fechas -->
    <div class="flex flex-col gap-2 mb-4">
      <label for="fechainiciotemporada" class="text-base font-medium">Fecha de Inicio</label>
      <input
        id="fechainiciotemporada"
        name="fechainiciotemporada"
        type="date"
        value={temporada?.fechainiciotemporada?.split("T")[0] ?? ""}
        class={inputClass}
      />
    </div>

    <div class="flex flex-col gap-2 mb-4">
      <label for="fechafintemporada" class="text-base font-medium">Fecha de Fin</label>
      <input
        id="fechafintemporada"
        name="fechafintemporada"
        type="date"
        value={temporada?.fechafintemporada?.split("T")[0] ?? ""}
        class={inputClass}
      />
    </div>

    <!-- Descripci贸n -->
    <div class="flex flex-col gap-2 mb-4">
      <label for="descripciontemporada" class="text-base font-medium">Descripci贸n</label>
      <textarea
        id="descripciontemporada"
        name="descripciontemporada"
        maxlength="250"
        rows="3"
        class={`${inputClass} resize-none`}
      >{temporada?.descripciontemporada ?? ""}</textarea>
    </div>

    <!-- Botones -->
    <div class="flex justify-center text-center mt-5 mx-5 pt-2 gap-5">
      <button class={buttonClass} type="button" id="btn-cancel">Cancelar</button>
      <button class={buttonClass} type="button" id="btn-submit">
        Actualizar Temporada
        <img src={arrowNext.src} class="size-7 rotate-180" alt="" />
      </button>
    </div>
  </form>
</FormLayout>

<script>
  import Swal from "sweetalert2";
  import { actions } from "astro:actions";
  import { navigate } from "astro:transitions/client";
  import { privateRoutesMap } from "@consts/routes";
  import { isTemporadaUpdated, validateTemporadas } from "@utils/validation/partidos/temporadas-validation";
import type { Temporada } from "@interfaces/torneos.interface";

  const form = document.getElementById("form-temporada") as HTMLFormElement;
  const btnSubmit = document.getElementById("btn-submit") as HTMLButtonElement;
  const btnCancel = document.getElementById("btn-cancel") as HTMLButtonElement;

  btnCancel.addEventListener("click", () => {
    navigate(privateRoutesMap.VER_TEMPORADAS);
  });

  btnSubmit.addEventListener("click", async () => {
    btnSubmit.disabled = true;
    btnSubmit.classList.add("opacity-50", "cursor-not-allowed");

    const formData = new FormData(form);
    const errorMessage = validateTemporadas(formData);
    const data = await actions.getTemporadaById.orThrow({
      id: Number.parseInt(formData.get("idtemporada")?.toString() ?? "0")
    });
    const temporadaActual = data.data as Temporada;
    const cambiosDetectados = isTemporadaUpdated(temporadaActual, formData);

    if(!cambiosDetectados) {
      Swal.fire("Informaci贸n", "No se han detectado cambios en la temporada.", "info").then(() => {
        btnSubmit.disabled = false;
        btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
      });
      return;
    }

    if (errorMessage) {
      Swal.fire("Error", errorMessage, "error").then(() => {
        btnSubmit.disabled = false;
        btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
      });
      return;
    }

    //  Normalizaci贸n de datos (solo ajuste de formato)
    const tipo = formData.get("tipotemporada")?.toString().trim() ?? "";
    const fechaInicio = formData.get("fechainiciotemporada")?.toString();
    const fechaFin = formData.get("fechafintemporada")?.toString();

    const fechaInicioISO = fechaInicio ? new Date(fechaInicio).toISOString() : "";
    const fechaFinISO = fechaFin ? new Date(fechaFin).toISOString() : "";

    formData.set("idtemporada", formData.get("idtemporada")?.toString() ?? "");
    formData.set("nombretemporada", formData.get("nombretemporada")?.toString().trim() ?? "");
    formData.set("descripciontemporada", formData.get("descripciontemporada")?.toString().trim() ?? "");
    formData.set("tipotemporada", tipo);
    formData.set("fechainiciotemporada", fechaInicioISO);
    formData.set("fechafintemporada", fechaFinISO);
    formData.set("temporadaactiva", formData.get("temporadaactiva")?.toString() ?? "");

    try {
      const { data, error } = await actions.updateTemporada(formData);

      if (error) {
        Swal.fire("Error", error.message, "error");
      } else {
        Swal.fire("xito", "Temporada actualizada correctamente", "success").then(() => {
          navigate(privateRoutesMap.VER_TEMPORADAS);
        });
      }
    } catch (err) {
      console.error("Error al actualizar:", err);
      Swal.fire("Error", "Ocurri贸 un problema al actualizar la temporada", "error");
      btnSubmit.disabled = false;
      btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
    } finally {
      btnSubmit.disabled = false;
      btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
    }
  });
</script>
