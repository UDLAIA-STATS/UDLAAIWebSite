---
import "@styles/global.css";
import FormLayout from "@layouts/FormLayout.astro";
import { actions } from "astro:actions";
import { Input, ComboBox, FormButtons } from "@components/molecules/forms/index";
import type { Equipo, Temporada, Torneo } from "@interfaces/torneos.interface";
import debug from "debug";

const user = Astro.cookies.get("user")
  ? (JSON.parse(Astro.cookies.get("user")?.value as string) as LoggedUser)
  : null;

// === Fetch de datos base ===
const { data, error } = await Astro.callAction(actions.getEquipos, {
  pageSize: 1000,
});
const { data: torneoData, error: torneoError } = await Astro.callAction(
  actions.getTorneos,
  { pageSize: 1000 }
);
const { data: temporadaData, error: temporadaError } = await Astro.callAction(
  actions.getTemporadas,
  { pageSize: 1000 }
);

if (error || torneoError || temporadaError) {
  debug.log("Error fetching equipos:", error);
  debug.log("Error fetching torneos:", torneoError);
  debug.log("Error fetching temporadas:", temporadaError);
  throw new Error("Error al recuperar datos necesarios para crear el partido.");
}

const equipos: Equipo[] = data?.results as Equipo[] ?? [];
const torneos: Torneo[] = torneoData?.results as Torneo[] ?? [];
const temporadas: Temporada[] = temporadaData?.results as Temporada[] ?? [];
---

<FormLayout formTitle="Agregar Partido" pageTitle="Agregar Partido" user={user}>
  <form id="form-partido" class="flex flex-col w-full max-w-md">
    <!-- Temporada -->
    <ComboBox id="idtemporada" label="Temporada">
      <option value="" disabled selected>Selecciona una temporada</option>
      {
        temporadas.map((temporada: Temporada) => (
          <option
            value={temporada.idtemporada}
            id={`temporada-${temporada.idtemporada}`}
          >
            {temporada.nombretemporada}
          </option>
        ))
      }
    </ComboBox>

    <!-- Torneo -->
    <ComboBox id="idtorneo" label="Torneo">
      <option value="" disabled selected>Selecciona un torneo</option>
      {
        torneos.length === 0 ? (
          <option value="" disabled>
            No hay torneos disponibles
          </option>
        ) : null
      }
      {
        torneos.map((torneo: Torneo) => (
          <option value={torneo.idtorneo} id={`torneo-${torneo.idtorneo}`}>
            {torneo.nombretorneo}
          </option>
        ))
      }
    </ComboBox>

    <Input
      id="fechapartido"
      label="Fecha del Partido"
      type="datetime-local"
    />

    <!-- Equipos -->
    <ComboBox id="idequipolocal" label="Equipo Local">
      <option value="" disabled selected>Selecciona un equipo</option>
      {
        equipos.map((equipo: Equipo) => (
          <option value={equipo.idequipo} id={`equipo-${equipo.idequipo}`}>
            {equipo.nombreequipo}
          </option>
        ))
      }
    </ComboBox>

    <ComboBox id="idequipovisitante" label="Equipo Visitante">
      <option value="" disabled selected>Selecciona un equipo</option>
      {
        equipos.map((equipo: Equipo) => (
          <option value={equipo.idequipo} id={`equipo-${equipo.idequipo}`}>
            {equipo.nombreequipo}
          </option>
        ))
      }
    </ComboBox>

    <!-- Marcadores -->
    <Input
      id="marcadorequipolocal"
      label="Marcador Equipo Local"
      type="number"
      min="0"
      max="100"
    />

    <Input
      id="marcadorequipovisitante"
      label="Marcador Equipo Visitante"
      type="number"
      min="0"
      max="100"
    />

    <FormButtons label="Crear Partido" />
  </form>
</FormLayout>

<script src="./scripts/create.ts"/>
