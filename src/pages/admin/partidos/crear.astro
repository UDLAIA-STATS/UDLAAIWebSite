---
import "@styles/global.css";
import FormLayout from "@layouts/FormLayout.astro";
import arrowNext from "@assets/arrow_next.svg";
import { actions } from "astro:actions";
import type {Equipo, Partido } from "@interfaces/torneos.interface";
import Swal from "sweetalert2";

interface Props {
  partido?: Partido | null;
}

const buttonClass =
  "text-[#C10230] bg-white border-[#C10230] border-solid border-2 px-4 py-2 rounded-md flex items-center justify-center cursor-pointer transition";
const inputClass =
  "bg-white text-black rounded-md p-2 w-md focus:outline-none focus:ring-2 focus:ring-[#C10230]";

const user = Astro.cookies.get("user")
  ? (JSON.parse(Astro.cookies.get("user")?.value as string) as LoggedUser)
  : null;

const { partido } = Astro.props;

const { data, error } = await actions.getEquipos();

if (error) {
  console.error("Error fetching equipos:", error);
  Swal.fire("Error", "Error al cargar los equipos", "error");
}


if (!data) {
    console.error("No data received for equipos");
    Swal.fire("Warning", "No se recibieron datos de los equipos.", "warning");
}

const equipos: Equipo[] = data?.data ?? [];

---

<FormLayout
  formTitle={partido ? "Editar Partido" : "Agregar Partido"}
  pageTitle={partido ? "Editar Partido" : "Agregar Partido"}
  user={user}
>
  <form id="form-partido" class="flex flex-col w-full max-w-md">
    <div class="flex gap-2 flex-col mb-4">
      <label for="tipopartido" class="text-base font-medium"
        >Tipo de partido</label
      >
      <select name="tipopartido" class={inputClass} id="tipopartido">
        <option value="oficial" selected={partido?.tipopartido === true}>Oficial</option>
        <option value="amistoso" selected={partido?.tipopartido === false}>Amistoso</option>
      </select>
    </div>

    <div class="flex gap-2 flex-col mb-4">
      <label for="marcadorequipolocal" class="text-base font-medium"
        >Marcador Equipo Local</label
      >
      <input
        id="marcadorequipolocal"
        name="marcadorequipolocal"
        value={partido?.marcadorequipolocal ?? ""}
        type="number"
        min="0"
        max="100"
        required
        class={inputClass} />
    </div>
    
    <div class="flex gap-2 flex-col mb-4">
      <label for="marcadorequipovisitante" class="text-base font-medium"
        >Marcador Equipo Visitante</label
      >
      <input
        id="marcadorequipovisitante"
        name="marcadorequipovisitante"
        value={partido?.marcadorequipovisitante ?? ""}
        type="number"
        min="0"
        max="100"
        required
        class={inputClass} />
    </div>
    
    <div class="flex gap-2 flex-col mb-4">
      <label for="fechapartido" class="text-base font-medium"
        >Fecha del Partido</label
      >
      <input
        id="fechapartido"
        name="fechapartido"
        value={partido?.fechapartido ?? ""}
        type="date"
        required
        class={inputClass} />
    </div>
    
    <div class="flex gap-2 flex-col mb-4">
      <label for="fechapartido" class="text-base font-medium"
        >Fecha del Partido</label
      >
      <input
        id="fechapartido"
        name="fechapartido"
        value={partido?.fechapartido ?? ""}
        type="date"
        required
        class={inputClass} />
    </div>

    <div class="flex gap-2 flex-col mb-4">
      <label for="idequipolocal" class="text-base font-medium"
        >Equipo Local</label
      >
      <select name="idequipolocal" class={inputClass} id="idequipolocal" required>
        <option value="" disabled selected>Selecciona un equipo</option>
        {equipos.map((equipo: Equipo) => (
          <option
            value={equipo.nombreequipo}
            id={`equipo-${equipo.idequipo}`}
            selected={equipo.idequipo === partido?.idequipolocal.idequipo}
          >
            {equipo.nombreequipo}
          </option>
        ))}
      </select>
    </div>

    <div class="flex gap-2 flex-col mb-4">
      <label for="idequipovisitante" class="text-base font-medium"
        >Equipo Visitante</label
      >
      <select name="idequipovisitante" class={inputClass} id="idequipovisitante" required>
        <option value="" disabled selected>Selecciona un equipo</option>
        {equipos.map((equipo: Equipo) => (
          <option
            value={equipo.nombreequipo}
            id={`equipo-${equipo.idequipo}`}
            selected={equipo.idequipo === partido?.idequipolocal.idequipo}
          >
            {equipo.nombreequipo}
          </option>
        ))}
      </select>
    </div>
    

    <div class="flex gap-2 justify-center pt-5">
      <button class={buttonClass} type="submit">
        {partido ? "Editar Partido" : "Agregar Partido"}
        <img src={arrowNext.src} class="size-7 rotate-180" alt="" />
      </button>
    </div>
  </form>
</FormLayout>

<script>
  import Swal from "sweetalert2";
  import { actions } from "astro:actions";

  const form = document.querySelector("#form-partido") as HTMLFormElement;
  const partidoId = "{partido?.idpartido ?? ''}" as string;

  document.addEventListener("astro:page-load", () => {
    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      if (partidoId && partidoId !== "") {
        formData.append("idpartido", partidoId);
      }

      try {
        const { data, error } =
          partidoId && partidoId !== ""
            ? await actions.updatePartido(formData)
            : await actions.createPartido(formData);

        if (error) throw error;
        Swal.fire(
          "Ã‰xito",
          partidoId ? "Partido actualizado" : "Partido creado",
          "success"
        );
        form.reset();
      } catch (err) {
        console.error(err as Error);
        Swal.fire("Error", "Error al crear el partido", "error");
      }
    });
  });
</script>
