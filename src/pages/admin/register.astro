---
import "@styles/global.css";
import FormLayout from "@layouts/FormLayout.astro";
import arrowNext from "@assets/arrow_next.svg";
import NotAuthorized from "@components/shared/NotAuthorized.astro";
import { roles } from "@consts/roles";

export const prerender = false;

const buttonClass =
  "text-[#C10230] bg-white border-[#C10230] border-solid border-2 w-full px-4 py-2 justify-center rounded-md flex cursor-pointer text-center";
const inputClass =
  "bg-white text-black rounded-md p-2 w-md focus:outline-none focus:ring-2 focus:ring-[#C10230]";

const user = Astro.cookies.get("user")
  ? (JSON.parse(Astro.cookies.get("user")?.value as string) as LoggedUser)
  : null;
const { super: superRole } = roles;
---

<FormLayout 
user={user} 
formTitle="Registro de Usuario" 
pageTitle="Registro de Usuario">
  <form autocomplete="on" method="post">
          <div class="flex flex-col gap-2 mb-4 px-5">
            <label class="text-base font-medium" for="name"> Nombre </label>
            <input
              type="text"
              maxlength="100"
              minlength="3"
              id="name"
              name="name"
              class={inputClass}
              required
            />
          </div>
          <div class="flex flex-col gap-2 mb-4 px-5">
            <label class="text-base font-medium" for="email">
              Correo Electrónico
            </label>
            <input
              type="email"
              maxlength="70"
              id="email"
              name="email"
              class={inputClass}
              required
            />
          </div>
          <div class="flex flex-col gap-2 mb-4 px-5">
            <label class="text-base font-medium" for="password">
              Contraseña
            </label>
            <input
              type="password"
              maxlength="30"
              minlength="8"
              id="password"
              name="password"
              class={inputClass}
              required
            />
          </div>
          <div class="flex justify-center text-center mt-5 mx-5 pt-2 gap-5">
            <button class={buttonClass} type="button" id="btn-cancel">
              Cancelar
            </button>
            <button class={buttonClass} type="submit" id="btn-register">
              Registrar
              <img
                src={arrowNext.src}
                class="size-7 align-middle pl-2 rotate-180"
                alt=""
              />
            </button>
          </div>
        </form>
</FormLayout>

<script>
  import { privateRoutesMap } from "@consts/routes";
import { actions } from "astro:actions";
import { navigate } from "astro:transitions/client";
  import Swal from "sweetalert2";

  const form = document.querySelector("form");
  const btnSubmit = form!.querySelector(
    "button[type='submit']"
  ) as HTMLButtonElement;
  const btnCancel = document.getElementById(
    "btn-cancel"
  ) as HTMLButtonElement;

  btnCancel.addEventListener("click", (e) => {
    e.preventDefault();
    navigate(privateRoutesMap.AUTH_ADMIN);
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    btnSubmit.setAttribute("disabled", "disabled");
    const formData = new FormData(form);
    const username = formData.get("name")?.toString().trim() ?? "";
    const email = formData.get("email")?.toString().trim().toLowerCase() ?? "";
    const password = formData.get("password")?.toString().trim() ?? "";
    const emailRegexp = new RegExp(/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/);
    const usernameRegexp = new RegExp(/^[a-zA-Z\s]{2,100}$/);
    const passwordRegexp = new RegExp(/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,50}$/);

    if (!usernameRegexp.test(username)) {
      Swal.fire({
        icon: "error",
        title: "Nombre inválido",
        text: "El nombre debe tener entre 3 y 100 caracteres y solo puede contener letras y espacios.",
      });
      btnSubmit.removeAttribute("disabled");
      return;
    }

    if (!emailRegexp.test(email)) {
      Swal.fire({
        icon: "error",
        title: "Correo electrónico inválido",
        text: "Por favor, ingresa un correo electrónico válido.",
      });
      btnSubmit.removeAttribute("disabled");
      return;
    }

    if (!passwordRegexp.test(password)) {
      Swal.fire({
        icon: "error",
        title: "Contraseña inválida",
        text: "La contraseña debe tener entre 8 y 50 caracteres, al menos una letra y un número.",
      });
      btnSubmit.removeAttribute("disabled");
      return;
    }



    const { value: userCredential } = await Swal.fire({
      title: "Ingrese su contraseña",
      input: "password",
      inputAttributes: {
        autocapitalize: "off",
      },
      showCancelButton: true,
      confirmButtonText: "Aceptar",
      cancelButtonText: "Cancelar",
      showLoaderOnConfirm: true,
      preConfirm: async (userCredential) => {
        if (!userCredential) {
          Swal.showValidationMessage("La contraseña es requerida");
          btnSubmit.removeAttribute("disabled");
          return;
        }

        return userCredential;
      },
    });

    formData.append("userCredential", userCredential);

    const { data, error } = await actions.registerUser(formData);

    if (error) {
      console.error("Error:", error);
      if (error.message.toString().includes("validation")) {
        Swal.fire({
          icon: "error",
          title: "Error al registrar el usuario",
          text: "Uno de los campos no es válido. Por favor, verifica e intenta nuevamente.",
        });
        btnSubmit.removeAttribute("disabled");
        return;
      }
      // const nameError = error. 
      Swal.fire({
        icon: "error",
        title: "Error al registrar el usuario",
        text: error.message,
      });
      btnSubmit.removeAttribute("disabled");
      return;
    }

    if (data) {
      console.log("Success:", data);
      Swal.fire({
        icon: "success",
        title: "Registro de usuario exitoso",
        text: "Por favor, inicia sesión.",
      });
    }
    btnSubmit.removeAttribute("disabled");
    form.reset();
  });
</script>
