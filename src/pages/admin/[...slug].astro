---
import type { GetStaticPaths } from "astro";
import "@styles/global.css";
import Layout from "@layouts/Layout.astro";
import arrowNext from "@assets/arrow_next.svg";
import NotAuthorized from "@components/shared/NotAuthorized.astro";
import { roles } from "@consts/roles";
import { actions } from "astro:actions"; 
import Swal from "sweetalert2";
import { publicRoutesMap } from "@consts/routes";
import type { User } from "@interfaces/user.interface";

const { username } = Astro.params;

console.log("Parámetro username:", username);

if (!username) {
  Astro.redirect(publicRoutesMap[404]);
}

const { data, error } = await Astro.callAction(actions.getUserByUsername, { username: username ?? "", userCredential: "123456789"});
if (!data) Astro.redirect(publicRoutesMap[404]);
const user: User = data!.data;


if (error) {
  console.error("Error fetching user:", error);
  Astro.redirect(publicRoutesMap[404]);
}

if (!user) {
  Astro.redirect(publicRoutesMap[404]);
};

const inputClass =
  "bg-white text-black rounded-md p-2 w-md focus:outline-none focus:ring-2 focus:ring-[#C10230]";


const { nombre_usuario, rol, email_usuario } = user;

const loggedUser = Astro.cookies.get("user")
  ? (JSON.parse(Astro.cookies.get("user")?.value as string) as LoggedUser)
  : null;
const { super: superRole } = roles;
---

<Layout>
  <section
    class:list={[
      "h-svh md:w-svw lg:w-shw w-shw flex flex-wrap justify-self-start flex-col mx-10 my-5",
      loggedUser && (loggedUser.rol === superRole || loggedUser.rol === roles.profesor)
        ? "hidden"
        : ""
    ]}
  >
    <NotAuthorized />
  </section>

  <section
    class:list={[
      "mx-10 my-5 w-svw h-svh flex flex-col",
      user && (user.rol === superRole || user.rol === roles.profesor)
        ? ""
        : "hidden"
    ]}
  >
    <h1 class="font-bold text-2xl text-center py-5">Editar Usuario</h1>
    <div
      id="container"
      class="flex flex-col items-center justify-center gap-5 rounded-sm bg-[#C10230] self-center w-fit px-10 py-5 mt-5 pb-8"
    >
      <form action="submit" method="post" autocomplete="on" id="form-usuario" class="text-white">
        <div class="flex flex-col gap-2 mb-4 px-5">
          <label class="text-base font-medium" for="name"> Nombre </label>
          <input
            type="text"
            maxlength="100"
            minlength="3"
            id="name"
            name="name"
            class={inputClass}
            value={nombre_usuario}
            required
          />
        </div>
        <div class="flex flex-col gap-2 mb-4 px-5">
          <label class="text-base font-medium" for="email">
            Correo Electrónico
          </label>
          <input
            type="email"
            maxlength="70"
            id="email"
            name="email"
            pattern="/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/"
            class={inputClass}
            value={email_usuario}
            required
          />
        </div>
        <div class="flex flex-col gap-2 mb-4 px-5">
          <label class="text-base font-medium" for="password">
            Contraseña
          </label>
          <input
            type="password"
            maxlength="30"
            minlength="8"
            id="password"
            name="password"
            class={inputClass}
            value={"*********"}
            required
          />
        </div>
        <div class="flex justify-center mt-5 pt-2">
          <button
            class="disabled:bg-gray-300 text-[#C10230] bg-white border-[#C10230] border-solid border-2 px-4 py-2 rounded-md cursor-pointer flex gap-2"
            type="submit"
            id="btn-login"
          >
            Editar Usuario
            <img
              src={arrowNext.src}
              class="size-7 align-middle pl-2 rotate-180"
              alt=""
            />
          </button>
        </div>
      </form>
    </div>
  </section>
</Layout>

<script>
  import Swal from "sweetalert2";
  import { actions } from "astro:actions";

  const form = document.querySelector("#form-usuario") as HTMLFormElement;
  const username = "{ username }" as string;
  console.log("Username:", username);

  const userCredential  = '123456789';

  document.addEventListener("astro:page-load", () => {
    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      formData.append("userCredential", userCredential);
      formData.append("username", username);
      try {
        const { data, error } = await actions.updateUser(formData);

        if (error) throw error;
        Swal.fire(
          "Éxito",
          `Usuario ${username} actualizado`,
          "success"
        );
        form.reset();
      } catch (err) {
        console.error(err as Error);
        Swal.fire("Error", "Error al crear el torneo", "error");
      }
    });
  });
</script>