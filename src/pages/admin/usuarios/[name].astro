---
import Layout from "@layouts/Layout.astro";
import arrowNext from "@assets/arrow_next.svg";
import NotAuthorized from "@components/shared/NotAuthorized.astro";
import { roles } from "@consts/roles";
import { actions } from "astro:actions";
import { publicRoutesMap } from "@consts/routes";

export const prerender = false;

const { name } = Astro.params;

const { data, error } = await Astro.callAction(actions.getUserByUsername, {
  username: name?.replaceAll("_", " ") ?? "",
  userCredential: "123456789",
});
const user = data?.data;

if (error || !user) {
  console.error("Error fetching user:", error);
  Astro.redirect(publicRoutesMap[404]);
}

const inputClass =
  "bg-white text-black rounded-md p-2 w-md focus:outline-none focus:ring-2 focus:ring-[#C10230]";
const buttonClass =
  "text-[#C10230] bg-white border-[#C10230] border-solid border-2 px-4 py-2 rounded-md flex items-center justify-center cursor-pointer transition";

const loggedUser = Astro.cookies.get("user")
  ? (JSON.parse(Astro.cookies.get("user")?.value as string) as LoggedUser)
  : null;
const { super: superRole } = roles;
---

<Layout>
  <section
    class:list={[
      "h-svh md:w-svw lg:w-shw w-shw flex flex-wrap justify-self-start flex-col mx-10 my-5",
      loggedUser &&
      (loggedUser.rol === superRole || loggedUser.rol === roles.profesor)
        ? "hidden"
        : "",
    ]}
  >
    <NotAuthorized />
  </section>

  <section
    class:list={[
      "mx-10 my-5 w-svw h-svh flex flex-col",
      loggedUser &&
      (loggedUser.rol === superRole || loggedUser.rol === roles.profesor)
        ? ""
        : "hidden",
    ]}
  >
    <h1 class="font-bold text-2xl text-center py-5">Editar Usuario</h1>
    <div
      id="container"
      class="flex flex-col items-center justify-center gap-5 rounded-sm bg-[#C10230] self-center w-fit px-10 py-5 mt-5 pb-8"
    >
      <form
        action=""
        method="post"
        autocomplete="on"
        id="form-usuario"
        class="text-white"
      >
        <div class="gap-2 mb-4 px-5 hidden">
          <label class="text-base font-medium" for="originalName">
            Nombre Actual
          </label>
          <input
            type="text"
            maxlength="100"
            minlength="3"
            id="originalName"
            name="originalName"
            class=`${inputClass}`
            value={user.nombre_usuario}
            readonly
          />
        </div>
        <div class="flex flex-col gap-2 mb-4 px-5">
          <label class="text-base font-medium" for="name"> Nombre </label>
          <input
            type="text"
            maxlength="100"
            minlength="3"
            id="name"
            name="name"
            class=`${inputClass}`
            value={user.nombre_usuario}
          />
        </div>
        <div class="flex flex-col gap-2 mb-4 px-5">
          <label class="text-base font-medium" for="email">
            Correo Electrónico
          </label>
          <input
            type="email"
            maxlength="70"
            id="email"
            name="email"
            value={user.email_usuario}
            class={inputClass}
            required
          />
        </div>
        <div class="flex flex-col gap-2 mb-4 px-5">
          <label class="text-base font-medium" for="password">
            Contraseña
          </label>
          <input
            type="password"
            maxlength="30"
            minlength="8"
            autocomplete="current-password"
            id="password"
            name="password"
            class={inputClass}
            placeholder="*********"
          />
        </div>
        <div class="flex justify-center text-center mt-5 mx-5 pt-2 gap-5">
          <button class={buttonClass} type="button" id="btn-cancel">
            Cancelar
          </button>
          <button
            class="disabled:bg-gray-300 text-[#C10230] bg-white border-[#C10230] border-solid border-2 px-4 py-2 rounded-md cursor-pointer flex gap-2"
            type="submit"
            id="btn-login"
          >
            Editar Usuario
            <img
              src={arrowNext.src}
              class="size-7 align-middle pl-2 rotate-180"
              alt=""
            />
          </button>
        </div>
      </form>
    </div>
  </section>
</Layout>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  import Swal from "sweetalert2/dist/sweetalert2.js";
  import { actions } from "astro:actions";
  import { privateRoutesMap } from "@consts/routes";
  import { navigate } from "astro:transitions/client";
  import type { User } from "@interfaces/user.interface";
  import validateUsers from "@utils/validation/admin/usuarios-validiation";

  const form = document.querySelector("#form-usuario") as HTMLFormElement;
  const userCredential = "123456789";
  const btnSubmit = form!.querySelector(
    "button[type='submit']"
  ) as HTMLButtonElement;
  const btnCancel = document.getElementById("btn-cancel") as HTMLButtonElement;

  btnCancel.addEventListener("click", (e) => {
    e.preventDefault();
    navigate(privateRoutesMap.ADMINS_USERS);
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    btnSubmit.disabled = true;
    btnSubmit.classList.add("opacity-50", "cursor-not-allowed");
    const formData = new FormData(form);
    const name = formData.get("name")?.toString().trim();
    const email = formData.get("email")?.toString().trim();
    const password = formData.get("password")?.toString().trim() ?? "";

    const errorMessage = validateUsers(formData);

    if (errorMessage.length > 0) {
      Swal.fire("Error", errorMessage, "error");
      btnSubmit.disabled = false;
      btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
      return;
    }

    formData.set("name", name ?? "");
    formData.set("email", email ?? "");
    formData.set("password", password ?? "");

    const originalName = formData.get("originalName")?.toString().trim() ?? "";
    const data = await actions.getUserByUsername.orThrow({
      username: originalName,
      userCredential: "123456789",
    });
    const user: User = data.data;
    const regexp = new RegExp(
      /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
    );

    if (
      name === user.nombre_usuario &&
      email === user.email_usuario &&
      (password === "" || password === null)
    ) {
      Swal.fire(
        "Error",
        "No se han realizado cambios en los datos del usuario.",
        "error"
      );
      btnSubmit.disabled = false;
      btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
      return;
    }

    if (password === "") {
      formData.delete("password");
    }
    if (
      name === originalName &&
      email === user.email_usuario &&
      password === ""
    ) {
      Swal.fire(
        "Error",
        "Debe modificar al menos un campo para actualizar el usuario",
        "error"
      );
      btnSubmit.disabled = false;
      btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
      return;
    }
    formData.append("userCredential", userCredential);
    try {
      const { data, error } = await actions.updateUser(formData);

      if (error) throw error;
      Swal.fire(
        "Éxito",
        `El usuario ${formData.get("originalName")} ha sido actualizado exitósamente.`,
        "success"
      ).then((result) => {
        if (result.isConfirmed) {
          navigate(privateRoutesMap.ADMINS_USERS);
        }
      });
      form.reset();
    } catch (err) {
      console.error(err as Error);
      Swal.fire("Error", "Error al actualizar el usuario", "error");
    } finally {
      btnSubmit.disabled = false;
      btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
    }
  });
</script>
