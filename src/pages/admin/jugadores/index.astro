---
import { privateRoutesMap } from "@consts/routes";
import { Table } from "@components/templates/tables/Table";
import type {
  SortOptions,
  TableActions,
  TableContent,
} from "@interfaces/table-actions.interface";
import EditIcon from "@assets/edit_icon_black.svg";
import DeleteIcon from "@assets/delete_icon_black.svg";
import NotAuthorized from "@components/organisms/NotAuthorized.astro";
import AdminPanelLayout from "@layouts/AdminPanelLayout.astro";
import TableActionsComponent from "@components/templates/partidosProfesor/TableActions.astro";
import Pagination from "@components/organisms/Pagination.astro";
import type { Player } from "@interfaces/index";
import { actions } from "astro:actions";

const searchParams = Astro.url.searchParams;
const pageParam = Number(searchParams.get("page") ?? 1);
const sortParam = searchParams.get("sortBy") ?? "";
const orderParam = searchParams.get("orderBy") ?? "asc";

const user = Astro.cookies.get("user")
  ? (JSON.parse(Astro.cookies.get("user")?.value as string) as LoggedUser)
  : null;

const { data: playerData, error: playerError } = await Astro.callAction(
  actions.getJugadores,
  {
    page: pageParam,
    pageSize: 10,
  },
);

if (playerError || !playerData) {
  throw new Error("Error al obtener jugadores");
}

const players: Player[] = playerData.results;
const pages = playerData.pages;

const { REGISTER_PLAYER, EDIT_PLAYER } = privateRoutesMap;

const headers: TableContent[] = [
  { data: "Banner" },
  { data: "Nombre" },
  { data: "Apellido" },
  { data: "PosiciÃ³n" },
  { data: "NÃºmero de camiseta" },
  { data: "Activo" },
  { data: "Editar" },
  { data: "Eliminar" },
];

const sortOptions: SortOptions[] = [
  { searchParam: "idbanner", displayName: "Banner" },
  { searchParam: "nombrejugador", displayName: "Nombre" },
  { searchParam: "apellidojugador", displayName: "Apellido" },
  { searchParam: "numerocamisetajugador", displayName: "NÃºmero de camiseta" },
];

const rows = players
  .map((u) => [
    u.idbanner,
    u.nombrejugador,
    u.apellidojugador,
    u.posicionjugador,
    u.numerocamisetajugador,
    u.jugadoractivo ? "SÃ­" : "No",
  ])
  .sort((a, b) => {
    if (!sortParam) return 0;

    const index = headers.findIndex(
      (header) =>
        header.data.toLowerCase() ===
        (sortParam === "idbanner"
          ? "banner"
          : sortParam === "nombrejugador"
            ? "nombre"
            : sortParam === "apellidojugador"
              ? "apellido"
              : sortParam === "numerocamisetajugador"
                ? "nÃºmero de camiseta"
                : ""),
    );

    if (index === -1) return 0;

    const aValue = a[index];
    const bValue = b[index];

    // ðŸ”¹ Orden numÃ©rico
    if (typeof aValue === "number" && typeof bValue === "number") {
      return orderParam === "asc" ? aValue - bValue : bValue - aValue;
    }

    // ðŸ”¹ Orden alfabÃ©tico (string)
    return orderParam === "asc"
      ? String(aValue).localeCompare(String(bValue), "es", {
          sensitivity: "base",
        })
      : String(bValue).localeCompare(String(aValue), "es", {
          sensitivity: "base",
        });
  });

function handleDelete(username: string) {
  console.log(`Usuario ${username} eliminado`);
}

const tableActions: TableActions[] = [];

tableActions.push(
  {
    href: `${EDIT_PLAYER}`,
    icon: EditIcon.src,
    alt: "Editar jugador",
    type: "link",
  },
  {
    action: handleDelete,
    icon: DeleteIcon.src,
    alt: "Eliminar jugador",
    type: "button",
  },
);
---

<AdminPanelLayout title="Panel de AdministraciÃ³n">
  {
    !user ? (
      <NotAuthorized />
    ) : (
      <div class="flex flex-col w-full h-full gap-5">
        <div class="flex flex-row gap-5 items-baseline justify-between w-full">
          <h1 class="font-bold text-2xl pr-5">Jugadores</h1>
          <TableActionsComponent
            canSort={true}
            sortByOptions={sortOptions}
            placeholderText="Buscar jugador..."
            buttonLabel="Crear Jugador"
            buttonHref={REGISTER_PLAYER}
          />
        </div>
        <div class="relative overflow-x-auto w-svw mt-5 flex justify-center">
          <Table headers={headers}>
            {rows.map((row) => (
              <tr class="border-b" id={`user-row-${row[0]}`}>
                {row.map((cell) => (
                  <td class="px-6 py-4">{cell}</td>
                ))}
                {tableActions &&
                  tableActions.length > 0 &&
                  tableActions.map((action) =>
                    action.type === "link" ? (
                      <td class="px-6 py-4">
                        <a
                          class="cursor-pointer no-underline"
                          href={`${action.href ?? ""}${row[0] ?? ""}`}
                        >
                          <img
                            class="size-8"
                            src={action.icon}
                            alt={action.alt}
                          />
                        </a>
                      </td>
                    ) : (
                      action.action && (
                        <td class="px-6 py-4">
                          <button
                            type="button"
                            id="delete-button"
                            value={row[0]}
                            data-delete-user
                            data-username={row[0]}
                            class="cursor-pointer"
                          >
                            <img
                              class="size-8"
                              src={action.icon}
                              alt={action.alt}
                            />
                          </button>
                        </td>
                      )
                    ),
                  )}
              </tr>
            ))}
          </Table>
        </div>
        <div class={`mt-2 ${pages <= 1 ? "hidden" : ""}`}>
          <Pagination totalPages={pages} />
        </div>
      </div>
    )
  }
</AdminPanelLayout>

<script src="./scripts/index.ts"></script>
