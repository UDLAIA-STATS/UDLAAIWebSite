---
import FormLayout from "@layouts/FormLayout.astro";
import { actions } from "astro:actions";
import {
  Input,
  ComboBox,
  FormButtons,
  TextArea,
} from "@components/forms/index";

const user = Astro.cookies.get("user")
  ? (JSON.parse(Astro.cookies.get("user")?.value as string) as LoggedUser)
  : null;

const { data: dataTemporadas, error } = await Astro.callAction(
  actions.getTemporadas,
  {
    page: 1,
    pageSize: 1000,
  }
);

if (error) {
  console.error("Error fetching temporadas:", error);
  throw new Error("No se pudo obtener la lista de temporadas.");
}

const temporadas = dataTemporadas?.data ?? [];
---

<FormLayout formTitle="Agregar Torneo" pageTitle="Agregar Torneo" user={user}>
  <form id="form-torneo" class="flex flex-col w-full max-w-md">
    <!-- Nombre del torneo -->
    <Input id="nombretorneo" label="Nombre del Torneo" required={true} />

    <!-- Temporada -->
    <ComboBox id="idtemporada" label="Temporada" required={true}>
      <option value="" disabled selected>Selecciona una temporada</option>
      {
        temporadas.map((temp) => (
          <option value={temp.idtemporada}>{temp.nombretemporada}</option>
        ))
      }
    </ComboBox>

    <!-- Fechas -->

    <Input
      id="fechainiciotorneo"
      label="Fecha de Inicio"
      type="date"
      required={true}
    />

    <!-- Fecha de fin -->
    <Input
      id="fechafintorneo"
      label="Fecha de Fin"
      type="date"
      required={true}
    />

    <!-- Torneo activo -->
    <ComboBox id="torneoactivo" label="Activo" required={true}>
      <option value="true" selected>Sí</option>
      <option value="false">No</option>
    </ComboBox>

    <!-- Descripción -->

    <TextArea
      id="descripciontorneo"
      label="Descripción"
      maxlength={250}
      rows={3}
    />

    <!-- Botones -->
    <FormButtons label="Guardar Torneo" />
  </form>
</FormLayout>

<script>
  import Swal from "sweetalert2";
  import { actions } from "astro:actions";
  import { navigate } from "astro:transitions/client";
  import { privateRoutesMap } from "@consts/routes";
  import { validateTorneo } from "@utils/validation/partidos/torneo-validation";

  const btnSubmit = document.getElementById("btn-submit") as HTMLButtonElement;
  const btnCancel = document.getElementById("btn-cancel") as HTMLButtonElement;
  const form = document.getElementById("form-torneo") as HTMLFormElement;
  const temporadasSelect = document.getElementById(
    "idtemporada"
  ) as HTMLSelectElement;

  temporadasSelect.addEventListener("change", async () => {
    const selectedValue = temporadasSelect.value;
    const data = await actions.getTemporadaById.orThrow({
      id: Number(selectedValue),
    });
    const temporada = data.data;
    const fechaInicioInput = document.getElementById(
      "fechainiciotorneo"
    ) as HTMLInputElement;
    const fechaFinInput = document.getElementById(
      "fechafintorneo"
    ) as HTMLInputElement;

    fechaInicioInput.value = temporada.fechainiciotemporada.split("T")[0];
    fechaInicioInput.min = temporada.fechainiciotemporada.split("T")[0];
    fechaInicioInput.max = temporada.fechafintemporada.split("T")[0];
    fechaFinInput.value = temporada.fechafintemporada.split("T")[0];
    fechaFinInput.min = temporada.fechainiciotemporada.split("T")[0];
    fechaFinInput.max = temporada.fechafintemporada.split("T")[0];
  });

  btnCancel.addEventListener("click", () => {
    navigate(privateRoutesMap.VER_TORNEOS);
  });

  btnSubmit.addEventListener("click", async () => {
    btnSubmit.disabled = true;
    btnSubmit.classList.add("opacity-50", "cursor-not-allowed");

    const formData = new FormData(form);
    const errorMessage = validateTorneo(formData);

    if (errorMessage) {
      Swal.fire("Error", errorMessage, "error");
      btnSubmit.disabled = false;
      btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
      return;
    }

    // Normalización de datos antes de enviar
    console.log("torneo Activo" + formData.get("torneoactivo"));
    const torneoActivo = formData.get("torneoactivo") === "true" ? true : false;

    const fechaInicio = new Date(formData.get("fechainiciotorneo") as string);
    const fechaFin = new Date(formData.get("fechafintorneo") as string);

    formData.set("fechainiciotorneo", fechaInicio.toISOString());
    formData.set("fechafintorneo", fechaFin.toISOString());
    formData.set("torneoactivo", torneoActivo.toString());

    try {
      const { data, error } = await actions.createTorneo(formData);

      if (error) {
        Swal.fire("Error", error.message, "error");
        btnSubmit.disabled = false;
        btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
        return;
      }

      Swal.fire("Éxito", "Torneo creado exitosamente", "success").then(() => {
        navigate(privateRoutesMap.VER_TORNEOS);
      });

      form.reset();
    } catch (err) {
      console.error("Error al crear torneo:", err);
      Swal.fire("Error", "Ocurrió un problema al crear el torneo", "error");
      btnSubmit.disabled = false;
      btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
    } finally {
      btnSubmit.disabled = false;
      btnSubmit.classList.remove("opacity-50", "cursor-not-allowed");
    }
  });
</script>
