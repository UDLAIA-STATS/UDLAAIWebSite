version: 2.1

defaults: &defaults
  docker:
    - image: cimg/node:22.8
  working_directory: ~/repo
  environment:
    NODE_ENV: development
    YARN_CACHE_FOLDER: .yarn/cache

jobs:
  test:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-yarn-cache-{{ arch }}-{{ checksum "yarn.lock" }}
            - v1-yarn-cache-

      - run:
          name: ðŸ“¥ Install dependencies
          command: yarn install --frozen-lockfile --prefer-offline

      - save_cache:
          paths:
            - .yarn/cache
          key: v1-yarn-cache-{{ arch }}-{{ checksum "yarn.lock" }}

      - run:
          name: ðŸ§ª Run Tests
          command: yarn test || echo "No tests defined"

  build:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-yarn-cache-{{ arch }}-{{ checksum "yarn.lock" }}
            - v1-yarn-cache-

      - run:
          name: ðŸ“¦ Install dependencies
          command: |
            yarn install --frozen-lockfile --prefer-offline

      - run:
          name: ðŸ—ï¸ Build Project
          command: |
            echo "Running yarn run build..."
            yarn run build

      - persist_to_workspace:
          root: .
          paths:
            - dist

      - store_artifacts:
          path: dist
          destination: dist

  deploy-prod:
    <<: *defaults
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo

      - run:
          name: ðŸš€ Deploy to Production
          command: |
            echo "Deploying to production (branch main)..."
            # Agrega aquÃ­ tus comandos reales (ej: firebase deploy, scp, etc.)

  notify:
    <<: *defaults
    steps:
      - run:
          name: ðŸ“§ Send Email Notification (Always runs)
          when: always
          command: |
            sudo apt-get update && sudo apt-get install -y mailutils
            echo "Preparando notificaciÃ³n de pipeline..."

            if [ "${CIRCLE_WORKFLOW_STATUS}" == "success" ]; then
              SUBJECT="âœ… Ã‰xito en el pipeline: ${CIRCLE_PROJECT_REPONAME} (${CIRCLE_BRANCH})"
              MESSAGE="El pipeline se completÃ³ correctamente.\n\nRepositorio: ${CIRCLE_PROJECT_REPONAME}\nBranch: ${CIRCLE_BRANCH}\nWorkflow: ${CIRCLE_WORKFLOW_ID}\n\nVer detalles:\n${CIRCLE_BUILD_URL}"
            else
              SUBJECT="âŒ Fallo en el pipeline: ${CIRCLE_PROJECT_REPONAME} (${CIRCLE_BRANCH})"
              MESSAGE="El pipeline fallÃ³.\n\nRepositorio: ${CIRCLE_PROJECT_REPONAME}\nBranch: ${CIRCLE_BRANCH}\nWorkflow: ${CIRCLE_WORKFLOW_ID}\n\nRevisa los logs:\n${CIRCLE_BUILD_URL}"
            fi

            echo -e "$MESSAGE" | mail -s "$SUBJECT" david.guaman@udla.edu.ec

# -------------------------
# WORKFLOW
# -------------------------
workflows:
  version: 2
  ci_cd_pipeline:
    jobs:
      - test
      - build:
          requires:
            - test
      - deploy-prod:
          requires:
            - build
          filters:
            branches:
              only: main
      - notify:
          requires:
            - build
          filters:
            branches:
              only:
                - develop
                - main
