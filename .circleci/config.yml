version: 2.1

orbs:
  node: circleci/node@5.1.0

defaults: &defaults
  docker:
    - image: cimg/node:22.8
  working_directory: ~/repo
  environment:
    NODE_ENV: development
    YARN_CACHE_FOLDER: .yarn/cache

jobs:
  test:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: ðŸ“¥ Install dependencies
          command: yarn install --frozen-lockfile
      - run:
          name: ðŸ§ª Run Tests
          command: yarn test

  build:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: ðŸ—ï¸ Build Application
          command: yarn build
      - persist_to_workspace:
          root: .
          paths:
            - dist

  deploy-prod:
    <<: *defaults
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: ðŸš€ Deploy to Production
          command: |
            echo "Deploying to production branch main..."
            # comandos reales de despliegue aquÃ­

  notify:
    <<: *defaults
    steps:
      - run:
          name: ðŸ“§ Send Email Notification
          command: |
            sudo apt-get update && sudo apt-get install -y mailutils
            if [ "${CIRCLE_JOB_STATUS}" == "success" ]; then
              SUBJECT="âœ… Pipeline Successful: ${CIRCLE_PROJECT_REPONAME} (${CIRCLE_BRANCH})"
              MESSAGE="All jobs completed successfully.\nPipeline URL: ${CIRCLE_BUILD_URL}"
            else
              SUBJECT="âŒ Pipeline Failed: ${CIRCLE_PROJECT_REPONAME} (${CIRCLE_BRANCH})"
              MESSAGE="Some jobs failed.\nCheck logs here: ${CIRCLE_BUILD_URL}"
            fi

            echo -e "$MESSAGE" | mail -s "$SUBJECT" david.guaman@udla.edu.ec

workflows:
  version: 2
  ci_cd_pipeline:
    jobs:
      - test
      - build:
          requires:
            - test
      - deploy-prod:
          requires:
            - build
          filters:
            branches:
              only: main
      - notify:
          requires:
            - build
          filters:
            branches:
              only:
                - develop
                - main
